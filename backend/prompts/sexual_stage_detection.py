"""
性行为阶段检测提示词

目的：检测当前对话所处的性行为阶段，以便在高风险阶段注入约束提醒

阶段定义与系统提示（system.py 148-162行）完全一致：
- 插入前
- 准备插入
- 插入时
- 抽插时
- 角色高潮（自然发生）
- 其他（非上述阶段的所有场景）

核心目标：防止AI写用户的未来状态（如"你快射了"），保持AI只描述观察到的事实
"""


def build_stage_detection_prompt(conversation: str) -> str:
    """
    构建性行为阶段检测提示词

    Args:
        conversation: 格式化的最近对话（2-3轮）

    Returns:
        完整的检测提示词
    """

    return f"""分析当前性行为阶段（客观事实）：

示例1 - 其他:
用户: 你好
角色: 很高兴见到你
阶段: 其他

示例2 - 其他:
用户: *亲吻你*
角色: *回应你的吻*
阶段: 其他

示例3 - 插入前:
用户: *手指探入你的小穴*
角色: *身体一颤* 好湿...
阶段: 插入前

示例4 - 准备插入:
用户: 分开腿
角色: *慢慢分开双腿* 龟头抵住了入口
阶段: 准备插入

示例5 - 插入时:
用户: *慢慢插入*
角色: *身体僵硬* 啊...进来了
阶段: 插入时

示例6 - 抽插时:
用户: *加快速度*
角色: *随着节奏身体晃动*
阶段: 抽插时

示例7 - 角色高潮（自然发生）:
用户: 继续
角色: *身体开始颤抖* 我快要...
阶段: 角色高潮（自然发生）

当前对话:
{conversation}

判断标准：
- 其他：日常对话、亲吻、爱抚等非插入性行为
- 插入前：手指爱抚小穴、润滑准备
- 准备插入：摆好姿势、龟头抵住入口但还未插入
- 插入时：正在插入或刚刚插入
- 抽插时：正在抽插运动（最高风险阶段！）
- 角色高潮（自然发生）：角色表达接近或正在高潮

只返回一个词（其他/插入前/准备插入/插入时/抽插时/角色高潮（自然发生））:"""
